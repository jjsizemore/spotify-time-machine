# Codecov Integration Setup

This document explains how Codecov is integrated into the spotify-time-machine project for tracking code coverage across the codebase.

## Overview

Codecov automatically collects, analyzes, and tracks code coverage metrics from test runs in the GitHub Actions CI/CD pipeline. It provides:

- **Coverage Reports**: Detailed metrics on lines, branches, functions, and statements covered by tests
- **PR Comments**: Automatic comments on pull requests with coverage changes
- **Coverage Trends**: Historical tracking of coverage over time
- **Status Checks**: Required or informational checks on PRs based on coverage targets

## Setup Completed ✅

### 1. Configuration Files

#### `codecov.yml` (Project Root)

The main Codecov configuration file that defines:

- **Coverage Targets**: 70% target coverage with 5% threshold
- **Scoped Paths**: Focuses on `src/` directory for meaningful metrics
- **Excluded Paths**: Ignores:
  - Test files and fixtures
  - Next.js framework files (pages, layouts, loading, error states)
  - Configuration files
  - Build artifacts
- **PR Comments**: Automatic coverage reports on pull requests
- **GitHub Integration**: Annotations and status checks for projects and patches

### 2. GitHub Actions Integration

#### Workflow File: `.github/workflows/test.yml`

The `merge-reports` job includes:

```yaml
- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v5
  with:
    files: ./coverage/lcov.info
    flags: unittests
    name: codecov-umbrella
    fail_ci_if_error: false
    token: ${{ secrets.CODECOV_TOKEN }}
    verbose: true
  continue-on-error: true
```

**Key Configuration:**

- **Action Version**: v5 (latest with enhanced features)
- **Coverage Format**: LCOV format (generated by Vitest)
- **Token**: Uses GitHub Secret `CODECOV_TOKEN` (must be configured in repo settings)
- **Verbose Mode**: Enabled for detailed upload logs
- **Non-blocking**: Failures don't block PR merges (sets `continue-on-error`)

### 3. Vitest Configuration

#### File: `vitest.config.ts`

Coverage configuration already optimized for Codecov:

```typescript
coverage: {
  provider: 'v8',
  reporter: ['text', 'json', 'html', 'lcov', 'json-summary'],
  include: ['src/**/*.{js,jsx,ts,tsx}'],
  exclude: [
    'node_modules',
    'tests',
    '__tests__',
    'coverage',
    'dist',
    '.next',
    'src/app/**/page.{js,jsx,ts,tsx}',
    'src/app/**/layout.{js,jsx,ts,tsx}',
    'src/app/**/loading.{js,jsx,ts,tsx}',
    'src/app/**/error.{js,jsx,ts,tsx}',
    'src/proxy.{js,ts}',
    'next.config.*',
    'postcss.config.*',
    'tailwind.config.*',
    '**/*.config.*',
  ],
  thresholds: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70,
    },
  },
}
```

- **Provider**: V8 (built-in Node.js coverage engine)
- **LCOV Reporter**: Generates `coverage/lcov.info` for Codecov upload
- **Include/Exclude Patterns**: Aligned with `codecov.yml`
- **Thresholds**: 70% minimum coverage across all metrics

### 4. README Badge

Added to `README.md`:

```markdown
[![codecov](https://codecov.io/github/jjsizemore/spotify-time-machine/branch/main/graph/badge.svg)](https://codecov.io/github/jjsizemore/spotify-time-machine)
```

This provides a live coverage badge in the repository documentation.

## GitHub Secret Configuration

**Required Step**: Configure `CODECOV_TOKEN` in GitHub repository settings:

1. Go to: **Settings → Secrets and variables → Actions**
2. Click **New repository secret**
3. Name: `CODECOV_TOKEN`
4. Value: Your Codecov repository upload token (from app.codecov.io)

## Testing Locally

Generate coverage reports locally:

```bash
# Full coverage report
pnpm test:coverage

# Check coverage for specific project
pnpm test:unit --coverage
pnpm test:integration --coverage
pnpm test:browser --coverage

# View HTML report
open coverage/index.html
```

This generates:

- `coverage/lcov.info` - LCOV format (for Codecov)
- `coverage/index.html` - Interactive HTML report
- `coverage/coverage-summary.json` - JSON summary
- Console output - Terminal-friendly report

## Coverage Workflow

### Per Test Run

1. **Test Execution**: Vitest runs with projects (unit, integration, browser, e2e)
2. **Coverage Collection**: V8 provider collects coverage metrics
3. **Report Generation**: Generates JSON, HTML, and LCOV reports
4. **Report Merging**: Sharded tests are merged via `test:merge-reports`

### In GitHub Actions

1. **Sharded Tests**: 4 parallel shards run with blob-format reports
2. **Report Download**: `actions/download-artifact` consolidates reports
3. **Report Merge**: `pnpm test:merge-reports` combines coverage data
4. **Codecov Upload**: `codecov/codecov-action` sends LCOV to Codecov
5. **PR Comment**: Codecov posts coverage change summary (if `comment` enabled in `codecov.yml`)

## Understanding the Coverage Reports

### Metrics Tracked

- **Lines**: % of executable lines covered
- **Branches**: % of conditional branches covered
- **Functions**: % of functions executed
- **Statements**: % of statements executed

### Thresholds in codecov.yml

```yaml
coverage:
  status:
    project:
      default:
        target: 70
        threshold: '5'
```

- **Target**: 70% coverage target
- **Threshold**: Allow 5 percentage point drop before marking as failed
- **Status**: Creates GitHub check visible on PRs

## Troubleshooting

### "No coverage files found"

- Ensure Vitest runs with `--coverage` flag
- Check that `coverage/lcov.info` exists after test run
- Verify `reporter: ['lcov']` in vitest.config.ts

### "Codecov upload failed"

- Verify `CODECOV_TOKEN` secret is set correctly
- Check GitHub Actions logs for error details (verbose mode helps)
- Ensure repository is connected to Codecov (app.codecov.io)

### Coverage Not Updating

- Codecov may cache results; try force-syncing from repo
- Check if the upload is using the correct branch
- Verify `codecov.yml` is in root directory

### False Negatives in Exclusions

- Next.js pages aren't unit testable (excluded by design)
- Configuration files are excluded (as intended)
- Test files are never included in coverage

## Advanced Configuration

### OIDC Authentication (Alternative to Token)

For enhanced security, use OpenID Connect instead of token:

```yaml
permissions:
  id-token: write
  contents: read

- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v5
  with:
    use_oidc: true
    files: ./coverage/lcov.info
```

### Custom Flags

Group coverage by test type:

```yaml
# In GitHub Actions, run separate uploads:
- uses: codecov/codecov-action@v5
  with:
    files: ./coverage/lcov.info
    flags: unittests # For unit/integration

- uses: codecov/codecov-action@v5
  with:
    files: ./coverage/lcov.info
    flags: browsertests # For browser tests
```

### Multiple Files

If running different test commands:

```yaml
with:
  files: ./coverage/unit/lcov.info,./coverage/integration/lcov.info
```

## Resources

- [Codecov Documentation](https://docs.codecov.com)
- [Codecov GitHub Action](https://github.com/codecov/codecov-action)
- [codecov.yml Reference](https://docs.codecov.com/docs/codecov-yaml)
- [Vitest Coverage](https://vitest.dev/guide/coverage.html)

## Next Steps

1. **Connect Repository**: Link this repo to Codecov (if not auto-linked)
2. **Configure Secret**: Add `CODECOV_TOKEN` to GitHub repository secrets
3. **Create Test Run**: Push a commit to trigger the workflow
4. **Monitor Dashboard**: Visit [app.codecov.io](https://app.codecov.io) to view results
5. **Set PR Requirements**: Optional - require coverage checks to pass before merging

---

**Status**: ✅ Codecov integration is fully configured and ready to use.
